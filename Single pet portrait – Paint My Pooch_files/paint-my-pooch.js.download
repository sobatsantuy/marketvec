 window.dataLayer = window.dataLayer || []; function initGSFTrackerJS(){ } function gtag() { dataLayer.push(arguments); } var generateProductIds = function (items, type = 'google') { var gsf_pids = []; for (var i = 0; i < items.length; i++) { var gsf_pid = generateProductItemsId(items[i],type); if(gsf_pid){ gsf_pids.push(gsf_pid); } } return gsf_pids; }; var generateProductItemsId = function (items, type = 'google') { var bing_sku_as_product_id = '-1'; var gsf_item_pid = 'shopify_AU' + '_' + items.product_id + '_' + items.variant_id; if(type == 'bing' && bing_sku_as_product_id != -1){ if (parseInt('-1') === 1) { gsf_item_pid = items.sku; } else if (parseInt('-1') === 2) { gsf_item_pid = items.variant_id; } } else { if (parseInt('0') === 1) { gsf_item_pid = items.sku; } else if (parseInt('0') === 2) { gsf_item_pid = items.variant_id; } } return gsf_item_pid; }; var getShopCurrency = function (items) { var gsf_shop_currency = ''; if(items.shop_currency != ''){ gsf_shop_currency = items.shop_currency; } return gsf_shop_currency; }; var getShopProductData = function (items,type) { var gsf_shop_pdata = ''; var gsf_shop_pids = []; for (var i = 0; i < items.length; i++) { var gsf_item = items[i]; if(type == 'name' || type == 'title'){ var gsf_shop_pdata = (type == 'title')? gsf_item.product_title : gsf_item.name; } else if(type == 'category'){ var gsf_shop_pdata = gsf_item.category; } else if(type == 'id'){ gsf_shop_pids.push(gsf_item.product_id); } } return (type == 'id')? gsf_shop_pids : gsf_shop_pdata; }; function gsfCallInitiateCheckout(total_price,shop_currency,cart_item,num_items) { gtag('event', 'conversion', { 'send_to': 'AW-657238841/', 'value': total_price }); } var gsfLoadScript = function(url, callback) { var script = document.createElement('script'); script.type = 'text/javascript'; if (script.readyState) { script.onreadystatechange = function() { if (script.readyState == 'loaded' || script.readyState == 'complete') { script.onreadystatechange = null; callback(); } }; } else { script.onload = function() { callback(); }; } script.src = url; document.getElementsByTagName('head')[0].appendChild(script); }; var prepareAdditionalEvent = function (gsf_jQuery) { function prepareAddtoCart() { gsf_jQuery("form[action^='/cart/add']").on('submit', function (e) { if (!(e.defaultPrevented || e.isDefaultPrevented && e.isDefaultPrevented())) { triggerAddToCart(false); } }); var _generic_ajax_open = XMLHttpRequest.prototype.open; var _generic_ajax_send = XMLHttpRequest.prototype.send; XMLHttpRequest.prototype.open = function (method, url) { this._method = method; this._url = url; _generic_ajax_open.apply(this, arguments); }; XMLHttpRequest.prototype.send = function () { this.addEventListener('readystatechange', function () { if (this.readyState === XMLHttpRequest.DONE) { if (this._url.indexOf('/cart/add') !== -1) { var cart_item = JSON.parse(this.responseText); triggerAddToCart(cart_item); } if (this._url.indexOf('/apps/oneclickupsell/upsellapp_cart') !== -1) { triggerCheckout(); } } }); _generic_ajax_send.apply(this, arguments); }; var _generic_fetch_open = window.fetch; window.fetch = function() { return new Promise((resolve, reject) => { _generic_fetch_open.apply(this, arguments) .then((response) => { if(response.url.indexOf('/cart/add') > -1 && response.status == 200){ response.clone().json().then((cart_item) => { if(typeof cart_item.items != 'undefined' && cart_item.items.length > 0){ cart_item = cart_item.items[0]; } triggerAddToCart(cart_item); }).catch((err) => { console.log(err); }); } resolve(response); }).catch((error) => { console.log(error); reject(error); }); }); }; } function prepareCheckout() { gsf_jQuery(':submit', gsf_jQuery("form[action='/cart'],form[action^='/cart?']")).on('click', function (e) { if (gsf_jQuery(this).attr('name') == 'checkout') { triggerCheckout(); } }); gsf_jQuery(document).on('click', '.gsf_checkout_btn, .shopify-payment-button, .ucd-checkout-btn, .opcCheckout, .carthook_checkout, .ymp_elem_mainBtn, .js-ajax-checkout-button, .cart__checkout, .agree-checkout', function(e) { if (typeof gsf_conversion_data != 'undefined' && gsf_conversion_data && gsf_conversion_data.page_type && (gsf_conversion_data.page_type == 'cart' || gsf_conversion_data.page_type == 'product') && gsf_conversion_data.data.total_price > 0 ) { var gsf_shop_currency = getShopCurrency(gsf_conversion_data.data); gsfCallInitiateCheckout(gsf_conversion_data.data.total_price,gsf_shop_currency,gsf_conversion_data.data.product_data,gsf_conversion_data.data.num_items); } else { gtag('event', 'conversion', { 'send_to': 'AW-657238841/', }); } }); } function triggerCheckout() { if(typeof gsf_conversion_data != 'undefined' && gsf_conversion_data && gsf_conversion_data.page_type && gsf_conversion_data.page_type == 'cart' && gsf_conversion_data.data.total_price > 0) { var gsf_shop_currency = getShopCurrency(gsf_conversion_data.data); gsfCallInitiateCheckout(gsf_conversion_data.data.total_price,gsf_shop_currency,gsf_conversion_data.data.product_data,gsf_conversion_data.data.num_items); } else { gsf_jQuery.ajax({ type: 'GET', url: 'https://paintmypooch.com.au/cart.js?t=' + Date.now(), dataType: 'json', success: function (response) { if(response && response.total_price && response.total_price > 0) { var cart_total_price = (response.total_price / 100); var cart_item = (response.items); gsfCallInitiateCheckout(cart_total_price,response.currency,cart_item,response.item_count); } }, }); } } function triggerAddToCart(cart_item) { var gsf_gtag_args = {}; if(cart_item) { gsf_gtag_args.ecomm_prodid = generateProductIds([cart_item]); gsf_gtag_args.ecomm_totalvalue = parseFloat((cart_item.price / 100).toFixed(2)); var gsf_prod_ids = getShopProductData([cart_item],'id'); var gsf_prod_name = getShopProductData([cart_item],'title'); var gsf_bing_ecomm_prodid = generateProductIds([cart_item],'bing'); } else { if (typeof gsf_conversion_data != 'undefined' && gsf_conversion_data && gsf_conversion_data.data.total_price > 0 ) { gsf_gtag_args.ecomm_prodid = generateProductIds(gsf_conversion_data.data.product_data); gsf_gtag_args.ecomm_totalvalue = gsf_conversion_data.data.total_price; var gsf_prod_ids = getShopProductData(gsf_conversion_data.data.product_data,'id'); var gsf_prod_name = getShopProductData(gsf_conversion_data.data.product_data,'name'); var gsf_bing_ecomm_prodid = generateProductIds(gsf_conversion_data.data.product_data,'bing'); } else { console.log('Conversion Tracking Snippet is Missing'); } } if(gsf_gtag_args.ecomm_totalvalue != 'undefined' && gsf_gtag_args.ecomm_totalvalue && gsf_gtag_args.ecomm_totalvalue > 0) { gsf_gtag_args.send_to = 'AW-657238841'; gsf_gtag_args.ecomm_pagetype = 'cart'; gtag('event', 'add_to_cart', gsf_gtag_args); gtag('event', 'conversion', { 'send_to': 'AW-657238841/', 'value': gsf_gtag_args.ecomm_totalvalue }); } } }; function gsfLoadjQuery(){ if (!window.jQuery || typeof jQuery === 'undefined') { gsfLoadScript('//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js', function () { gsf_jQuery = jQuery.noConflict(true); prepareAdditionalEvent(gsf_jQuery); }); } else { prepareAdditionalEvent(jQuery); } } function initGSFTracker() { gsfLoadjQuery(); gtag('js', new Date()); gtag('config', 'AW-657238841'); var gsf_shopify_checkout = Shopify.checkout || []; var gsf_line_items = gsf_shopify_checkout.line_items || []; var is_thank_you_page = 0; if (location.href.includes('thank_you') && Shopify.checkout.total_price && gsf_line_items.length > 0) { is_thank_you_page = 1; if(Shopify.checkout.presentment_currency && Shopify.checkout.presentment_currency != ''){ var currency = Shopify.checkout.presentment_currency; }else{ var currency = Shopify.checkout.currency; } } if (typeof gsf_conversion_data != 'undefined' && typeof gsf_conversion_data.page_type != 'undefined' && typeof gsf_conversion_data.event != 'undefined' && gsf_conversion_data.page_type !== '' && gsf_conversion_data.event !== '' ) { var gsf_gtag_args = { send_to: 'AW-657238841', ecomm_pagetype: gsf_conversion_data.page_type }; gsf_gtag_args.ecomm_prodid = generateProductIds(gsf_conversion_data.data.product_data); gsf_gtag_args.ecomm_totalvalue = gsf_conversion_data.data.total_price; gtag('event', 'page_view', gsf_gtag_args); } if (is_thank_you_page == 1) { var product_data = []; var total_price = Shopify.checkout.total_price || 0; for(i in gsf_line_items) { var item = gsf_line_items[i]; var p_data = {variant_id:item.variant_id,product_id:item.product_id,name:item.title,price:item.price,currency:currency,sku:item.sku,brand:item.vendor,variant:item.variant_title,category:''}; product_data.push(p_data); } gtag('event', 'page_view', { 'send_to': 'AW-657238841', 'ecomm_pagetype': 'purchase' , 'ecomm_prodid': generateProductIds(product_data), 'ecomm_totalvalue' : total_price, }); } } function initGSFTrackerJSCode(){ var gsf_script = document.createElement('script'); gsf_script.src = 'https://www.googletagmanager.com/gtag/js?id=AW-657238841'; document.head.append(gsf_script); gsf_script.onload = initGSFTracker; } function initGSFTrackerFunction(){ initGSFTrackerJS(); initGSFTrackerJSCode(); } (function() { initGSFTrackerFunction(); })(); 